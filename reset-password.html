<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer contraseña - Nutrimetrics</title>
    
    <!-- TailwindCSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #4FD1C5 0%, #38B2AC 100%);
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <!-- Header -->
            <div class="text-center">
                <div class="mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-[#4FD1C5]/10">
                    <svg class="h-8 w-8 text-[#4FD1C5]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                </div>
                <h2 class="mt-6 text-3xl font-extrabold text-gray-900">
                    Restablecer contraseña
                </h2>
                <p class="mt-2 text-sm text-gray-600">
                    Ingresa tu nueva contraseña para completar el proceso
                </p>
            </div>

            <!-- Formulario -->
            <form id="resetForm" class="mt-8 space-y-6">
                <div class="space-y-4">
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">
                            Nueva contraseña
                        </label>
                        <div class="mt-1 relative">
                            <input 
                                id="password" 
                                name="password" 
                                type="password" 
                                required 
                                class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-[#4FD1C5] focus:border-[#4FD1C5] focus:z-10 sm:text-sm"
                                placeholder="Ingresa tu nueva contraseña"
                                minlength="6"
                            >
                        </div>
                    </div>
                    
                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700">
                            Confirmar contraseña
                        </label>
                        <div class="mt-1 relative">
                            <input 
                                id="confirmPassword" 
                                name="confirmPassword" 
                                type="password" 
                                required 
                                class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-[#4FD1C5] focus:border-[#4FD1C5] focus:z-10 sm:text-sm"
                                placeholder="Confirma tu nueva contraseña"
                                minlength="6"
                            >
                        </div>
                    </div>
                </div>

                <!-- Mensajes de estado -->
                <div id="messageContainer" class="hidden">
                    <div id="successMessage" class="hidden rounded-md bg-green-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p id="successText" class="text-sm font-medium text-green-800"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="errorMessage" class="hidden rounded-md bg-red-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p id="errorText" class="text-sm font-medium text-red-800"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botón de envío -->
                <div>
                    <button 
                        type="submit" 
                        id="submitButton"
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-[#4FD1C5] hover:bg-[#4FD1C5]/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#4FD1C5] transition-colors duration-200"
                    >
                        <span id="buttonText">Restablecer contraseña</span>
                        <span id="loadingSpinner" class="hidden ml-2">
                            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </form>

            <!-- Footer -->
            <div class="text-center">
                <p class="text-xs text-gray-500">
                    ¿Recordaste tu contraseña? 
                    <a href="#" class="font-medium text-[#4FD1C5] hover:text-[#4FD1C5]/80">
                        Iniciar sesión
                    </a>
                </p>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ssedsxqfinqnkwuejlxx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzZWRzeHFmaW5xbmt3dWVqbHh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4Mjk1OTgsImV4cCI6MjA2ODQwNTU5OH0._RYdxDXBUkg_xwhiwdPxzKDhes8_A1WlSlTN_AmipZM';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let isAuthenticated = false;
        
        const form = document.getElementById('resetForm');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const messageContainer = document.getElementById('messageContainer');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const successText = document.getElementById('successText');
        const errorText = document.getElementById('errorText');
        
        function showMessage(type, message) {
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            messageContainer.classList.add('hidden');
            
            if (type === 'success') {
                successText.textContent = message;
                successMessage.classList.remove('hidden');
                messageContainer.classList.remove('hidden');
            } else if (type === 'error') {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
                messageContainer.classList.remove('hidden');
            }
        }
        
        function setLoading(loading) {
            if (loading) {
                submitButton.disabled = true;
                buttonText.textContent = 'Procesando...';
                loadingSpinner.classList.remove('hidden');
            } else {
                submitButton.disabled = false;
                buttonText.textContent = 'Restablecer contraseña';
                loadingSpinner.classList.add('hidden');
            }
        }
        
        function validatePasswords() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (password.length < 6) {
                showMessage('error', 'La contraseña debe tener al menos 6 caracteres');
                return false;
            }
            
            if (password !== confirmPassword) {
                showMessage('error', 'Las contraseñas no coinciden');
                return false;
            }
            
            return true;
        }
        
        async function initializeAuth() {
            try {
                const { data, error } = await supabase.auth.getSessionFromUrl({ 
                    storeSession: true 
                });
                
                if (error) {
                    showMessage('error', 'Error al autenticar. Verifica que el enlace sea válido.');
                    return;
                }
                
                if (data.session) {
                    isAuthenticated = true;
                    showMessage('success', 'Autenticación exitosa. Puedes cambiar tu contraseña.');
                } else {
                    showMessage('error', 'Enlace inválido o expirado. Solicita un nuevo enlace de restablecimiento.');
                }
                
            } catch (error) {
                showMessage('error', 'Error inesperado durante la autenticación.');
            }
        }
        
        async function handleSubmit(event) {
            event.preventDefault();
            
            if (!isAuthenticated) {
                showMessage('error', 'Debes estar autenticado para cambiar la contraseña.');
                return;
            }
            
            if (!validatePasswords()) {
                return;
            }
            
            const newPassword = passwordInput.value;
            
            setLoading(true);
            
            try {
                const { data, error } = await supabase.auth.updateUser({ 
                    password: newPassword 
                });
                
                if (error) {
                    showMessage('error', `Error al actualizar contraseña: ${error.message}`);
                    return;
                }
                
                if (data.user) {
                    showMessage('success', '¡Contraseña actualizada exitosamente! Ya puedes iniciar sesión con tu nueva contraseña.');
                    
                    form.reset();
                    
                    submitButton.disabled = true;
                    buttonText.textContent = 'Contraseña actualizada';
                }
                
            } catch (error) {
                showMessage('error', 'Error inesperado al actualizar la contraseña.');
            } finally {
                setLoading(false);
            }
        }
        
        form.addEventListener('submit', handleSubmit);
        
        confirmPasswordInput.addEventListener('input', () => {
            if (confirmPasswordInput.value && passwordInput.value !== confirmPasswordInput.value) {
                confirmPasswordInput.classList.add('border-red-500');
                confirmPasswordInput.classList.remove('border-gray-300');
            } else {
                confirmPasswordInput.classList.remove('border-red-500');
                confirmPasswordInput.classList.add('border-gray-300');
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeAuth();
        });
    </script>
</body>
</html>
